#!/usr/bin/env bash
# dotty guard â€” pre-commit hook that blocks sensitive content.
# Installed by `dotty guard`. Do not edit directly.

set -euo pipefail

patterns="${DOTTY_GUARD_PATTERNS:-}"
[[ -n "$patterns" ]] || exit 0

# Build combined regex from newline-separated patterns, skipping blanks and comments.
combined=""
while IFS= read -r line; do
    line="${line## }"
    line="${line%% }"
    [[ -z "$line" || "$line" == \#* ]] && continue
    [[ -n "$combined" ]] && combined+="|"
    combined+="$line"
done <<< "$patterns"

[[ -n "$combined" ]] || exit 0

matches="$(git diff --cached --diff-filter=ACMR -U0 | grep -iE "$combined" || true)"
if [[ -n "$matches" ]]; then
    echo ""
    echo "  Commit blocked. Staged changes contain sensitive content."
    echo ""
    echo "  DOTTY_GUARD_PATTERNS is configured to prevent committing content"
    echo "  that matches these patterns (e.g. internal URLs, repo names):"
    echo ""
    echo "  Matches found:"
    echo ""
    echo "$matches" | head -20 | while IFS= read -r line; do
        echo "    $line"
    done
    local_count="$(echo "$matches" | wc -l | tr -d ' ')"
    if [[ "$local_count" -gt 20 ]]; then
        echo "    ... and $((local_count - 20)) more"
    fi
    echo ""
    echo "  To see all matches:"
    echo ""
    echo "    git diff --cached | grep -iE '$combined'"
    echo ""
    exit 1
fi
